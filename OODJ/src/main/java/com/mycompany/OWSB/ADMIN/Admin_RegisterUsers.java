/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JPanel.java to edit this template
 */
package com.mycompany.OWSB.ADMIN;

import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import javax.swing.JOptionPane;

/**
 *
 * @author cindy
 */
public class Admin_RegisterUsers extends javax.swing.JPanel {
    private javax.swing.JPanel ChangePanel;

    /**
     * Creates new form Admin_RegisterUsers
     */
    public Admin_RegisterUsers(javax.swing.JPanel ChangePanel) {
        this.ChangePanel = ChangePanel;
        initComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        RegisterUser_Label = new javax.swing.JLabel();
        SelectRole_Label = new javax.swing.JLabel();
        Username_Label = new javax.swing.JLabel();
        Password_Label = new javax.swing.JLabel();
        SelectRole_Dropdown = new javax.swing.JComboBox<>();
        Username_TextField = new javax.swing.JTextField();
        Password_TextField = new javax.swing.JTextField();
        ClearButton = new javax.swing.JButton();
        RegisterButton = new javax.swing.JButton();

        setBackground(new java.awt.Color(255, 255, 255));

        RegisterUser_Label.setFont(new java.awt.Font("Comic Sans MS", 1, 36)); // NOI18N
        RegisterUser_Label.setText("Register User");

        SelectRole_Label.setFont(new java.awt.Font("Georgia", 0, 18)); // NOI18N
        SelectRole_Label.setText("Select Role:");

        Username_Label.setFont(new java.awt.Font("Georgia", 0, 18)); // NOI18N
        Username_Label.setText("Enter Username:");

        Password_Label.setFont(new java.awt.Font("Georgia", 0, 18)); // NOI18N
        Password_Label.setText("Enter Password:");

        SelectRole_Dropdown.setFont(new java.awt.Font("Georgia", 0, 14)); // NOI18N
        SelectRole_Dropdown.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Sales Manager (SM)", "Purchase Manager (PM)", "Finance Manager (FM)", "Inventory Manager (IM)" }));

        Username_TextField.setFont(new java.awt.Font("Georgia", 0, 18)); // NOI18N

        Password_TextField.setFont(new java.awt.Font("Georgia", 0, 18)); // NOI18N

        ClearButton.setFont(new java.awt.Font("Georgia", 0, 14)); // NOI18N
        ClearButton.setText("Clear");
        ClearButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                ClearButtonActionPerformed(evt);
            }
        });

        RegisterButton.setFont(new java.awt.Font("Georgia", 0, 14)); // NOI18N
        RegisterButton.setText("Register");
        RegisterButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                RegisterButtonActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(118, 118, 118)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(79, 79, 79)
                        .addComponent(RegisterUser_Label))
                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                        .addGroup(layout.createSequentialGroup()
                            .addComponent(ClearButton, javax.swing.GroupLayout.PREFERRED_SIZE, 82, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(RegisterButton))
                        .addGroup(layout.createSequentialGroup()
                            .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                .addComponent(Username_Label)
                                .addComponent(SelectRole_Label)
                                .addComponent(Password_Label))
                            .addGap(33, 33, 33)
                            .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                                .addComponent(Username_TextField, javax.swing.GroupLayout.Alignment.LEADING)
                                .addComponent(SelectRole_Dropdown, javax.swing.GroupLayout.Alignment.LEADING, 0, 235, Short.MAX_VALUE)
                                .addComponent(Password_TextField)))))
                .addContainerGap(115, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(62, 62, 62)
                .addComponent(RegisterUser_Label, javax.swing.GroupLayout.PREFERRED_SIZE, 50, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(80, 80, 80)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(SelectRole_Label)
                    .addComponent(SelectRole_Dropdown, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(Username_Label)
                    .addComponent(Username_TextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(Password_Label)
                    .addComponent(Password_TextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(83, 83, 83)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(RegisterButton, javax.swing.GroupLayout.PREFERRED_SIZE, 37, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(ClearButton, javax.swing.GroupLayout.PREFERRED_SIZE, 37, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(172, Short.MAX_VALUE))
        );
    }// </editor-fold>//GEN-END:initComponents

    private void ClearButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_ClearButtonActionPerformed
        // TODO add your handling code here:
        Username_TextField.setText(""); //clear username text field
        Password_TextField.setText(""); //clear password text field
    }//GEN-LAST:event_ClearButtonActionPerformed

    private void RegisterButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_RegisterButtonActionPerformed
        // TODO add your handling code here:
        String role = SelectRole_Dropdown.getSelectedItem().toString();
        String username = Username_TextField.getText().trim();
        String password = Password_TextField.getText().trim();
        
        if (username.isEmpty() || password.isEmpty()){
            JOptionPane.showMessageDialog(this, "Username and Password cannot be empty. Please fill in all the information.");
            return;
        }
        
        String Role_ID = "";
        if (role.startsWith("Sales Manager")) Role_ID = "SM";
        else if (role.startsWith("Purchase Manager")) Role_ID = "PM";
        else if (role.startsWith("Inventory Manager")) Role_ID = "IM";
        else if (role.startsWith("Finance Manager")) Role_ID = "FM";
        
        String Emp_ID = Generate_ID(Role_ID);
        String Emp_Data = Emp_ID + "," + username + "," + password + ",0,unlock";
        
        try (BufferedWriter bw = new BufferedWriter(new FileWriter("login.txt", true))){
            bw.write(Emp_Data);
            bw.newLine();
            bw.flush();
            JOptionPane.showMessageDialog(this, "User registered successfully. Employee ID: " + Emp_ID); 
        }catch (IOException e){
            JOptionPane.showMessageDialog(this, "Error writing to file: " + e.getMessage());
        }
    }//GEN-LAST:event_RegisterButtonActionPerformed

    private String Generate_ID(String Role_ID){
        int Max_ID = 0;
        File file = new File("login.txt");
        if (file.exists()){
            try (BufferedReader br = new BufferedReader(new FileReader(file))){
                String line;
                String pattern = "^(" + Role_ID + ")(\\d{3})$";
                Pattern compiledPattern = Pattern.compile(pattern);
                
                while ((line = br.readLine()) != null){
                    String[] sec = line.split(",");
                    if (sec.length > 0){
                        Matcher matcher = compiledPattern.matcher(sec[0]);

                        if (matcher.find()){
                            int Current_ID = Integer.parseInt(matcher.group(2));
                            if (Current_ID > Max_ID){
                                Max_ID = Current_ID;
                            }
                        } 
                    }
                }
            }catch (IOException e){
                JOptionPane.showMessageDialog(this, "Error reading file: " + e.getMessage());
            }
        }
        return Role_ID + String.format("%03d", Max_ID + 1); // Incerease the ID to 1 & Format to three digits number
    }
    
    

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton ClearButton;
    private javax.swing.JLabel Password_Label;
    private javax.swing.JTextField Password_TextField;
    private javax.swing.JButton RegisterButton;
    private javax.swing.JLabel RegisterUser_Label;
    private javax.swing.JComboBox<String> SelectRole_Dropdown;
    private javax.swing.JLabel SelectRole_Label;
    private javax.swing.JLabel Username_Label;
    private javax.swing.JTextField Username_TextField;
    // End of variables declaration//GEN-END:variables
}
